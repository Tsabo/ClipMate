<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="./min/vs/editor/editor.main.css"/>
    <style>
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; 
            background: transparent; 
        }
        #container { height: 100%; }
    </style>
</head>
<body>
<div id="container"></div>
<script src="./min/vs/loader.js"></script>
<script>
    require.config({ paths: { 'vs': './min/vs' } });
</script>
<script src="./min/vs/editor/editor.main.js"></script>
<script>
        // Global editor instance
        var monacoEditor = null;
        var debugMode = false;
        var suppressChangeEvents = false;
        var changeListener = null;
        var sqlSchema = null;
        var validationTimeout = null;
        var sqlCompletionProvider = null;
        var sqlHoverProvider = null;

        // Helper function to escape strings for Monaco
        function escapeText(text) {
            return text
                .replace(/\\/g, '\\\\')
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }

        // Initialize Monaco editor with given options
        function initializeEditor(options) {
            try {
                if (debugMode) {
                    console.log('[Monaco] Initializing editor with options:', options);
                }
                
                monacoEditor = monaco.editor.create(document.getElementById('container'), {
                    value: options.value || '',
                    language: options.language || 'plaintext',
                    theme: options.theme || 'vs-light',
                    fontSize: options.fontSize || 14,
                    fontFamily: options.fontFamily || 'Consolas, "Courier New", monospace',
                    wordWrap: options.wordWrap || 'off',
                    lineNumbers: options.lineNumbers || 'on',
                    minimap: { enabled: options.minimapEnabled !== false },
                    tabSize: options.tabSize || 4,
                    smoothScrolling: options.smoothScrolling !== false,
                    readOnly: options.readOnly || false,
                    automaticLayout: true
                });

                // Notify content changes (store listener for disposal)
                changeListener = monacoEditor.onDidChangeModelContent(() => {
                    if (suppressChangeEvents) {
                        if (debugMode) {
                            console.log('[Monaco] Content changed (suppressed)');
                        }
                        return;
                    }
                    if (debugMode) {
                        console.log('[Monaco] Content changed');
                    }
                    window.chrome.webview.postMessage({ type: 'textChanged' });
                    
                    // Trigger SQL validation if IntelliSense is enabled
                    if (sqlSchema && monacoEditor.getModel().getLanguageId() === 'sql') {
                        scheduleValidation();
                    }
                });

                if (debugMode) {
                    console.log('[Monaco] Editor initialized successfully');
                }
                window.chrome.webview.postMessage({ type: 'initialized', success: true });
                return true;
            } catch (error) {
                console.error('[Monaco] Initialization error:', error);
                window.chrome.webview.postMessage({ 
                    type: 'initialized', 
                    success: false, 
                    error: error.message 
                });
                return false;
            }
        }

        // Load content atomically (text, language, viewState)
        function loadContent(text, languageId, viewStateJson) {
            try {
                if (!monacoEditor) {
                    throw new Error('Editor not initialized');
                }

                if (debugMode) {
                    console.log('[Monaco] Loading content:', {
                        textLength: text ? text.length : 0,
                        language: languageId,
                        hasViewState: !!viewStateJson
                    });
                }

                // Suppress change events during load
                suppressChangeEvents = true;
                try {
                    // 1. Set text (creates new model)
                    monacoEditor.setValue(text || '');

                    // 2. Set language (must be after setValue)
                    if (languageId) {
                        monaco.editor.setModelLanguage(monacoEditor.getModel(), languageId);
                    }

                    // 3. Restore view state (must be last)
                    if (viewStateJson) {
                        try {
                            const viewState = JSON.parse(viewStateJson);
                            monacoEditor.restoreViewState(viewState);
                            if (debugMode) {
                                console.log('[Monaco] View state restored');
                            }
                        } catch (e) {
                            console.warn('[Monaco] Failed to restore view state:', e);
                        }
                    }

                    if (debugMode) {
                        console.log('[Monaco] Content loaded successfully');
                    }
                    return true;
                } finally {
                    // Always re-enable change events
                    suppressChangeEvents = false;
                }
            } catch (error) {
                console.error('[Monaco] Load content error:', error);
                suppressChangeEvents = false;
                return false;
            }
        }

        // Set language only (without full content reload)
        function setLanguage(languageId) {
            if (!monacoEditor) {
                return false;
            }
            try {
                if (debugMode) {
                    console.log('[Monaco] Setting language to:', languageId);
                }
                monaco.editor.setModelLanguage(monacoEditor.getModel(), languageId);
                return true;
            } catch (error) {
                console.error('[Monaco] Set language error:', error);
                return false;
            }
        }

        // Get current language
        function getLanguage() {
            if (!monacoEditor) {
                return 'plaintext';
            }
            return monacoEditor.getModel().getLanguageId();
        }

        // Get all available languages from Monaco
        function getAvailableLanguages() {
            try {
                const languages = monaco.languages.getLanguages();
                // Return just the language IDs sorted alphabetically
                return languages.map(lang => lang.id).sort();
            } catch (error) {
                console.error('[Monaco] Get available languages error:', error);
                return [];
            }
        }

        // Save view state
        function saveViewState() {
            if (!monacoEditor) {
                return null;
            }
            try {
                const viewState = monacoEditor.saveViewState();
                return JSON.stringify(viewState);
            } catch (error) {
                console.error('[Monaco] Save view state error:', error);
                return null;
            }
        }

        // Update editor options
        function updateOptions(options) {
            if (!monacoEditor) {
                return false;
            }
            try {
                monacoEditor.updateOptions(options);
                if (debugMode) {
                    console.log('[Monaco] Options updated');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Update options error:', error);
                return false;
            }
        }

        // Enable/disable debug mode
        function setDebugMode(enabled) {
            debugMode = enabled;
            console.log('[Monaco] Debug mode:', enabled ? 'enabled' : 'disabled');
        }

        // Get currently selected text
        function getSelectedText() {
            if (!monacoEditor) {
                return '';
            }
            try {
                const selection = monacoEditor.getSelection();
                if (!selection || selection.isEmpty()) {
                    return '';
                }
                const model = monacoEditor.getModel();
                return model.getValueInRange(selection);
            } catch (error) {
                console.error('[Monaco] Get selected text error:', error);
                return '';
            }
        }

        // Replace currently selected text
        function replaceSelection(text) {
            if (!monacoEditor) {
                return false;
            }
            try {
                const selection = monacoEditor.getSelection();
                if (!selection) {
                    return false;
                }
                
                // Use executeEdits with pushUndoStop for proper undo stack integration
                monacoEditor.executeEdits('toolbar', [{
                    range: selection,
                    text: text,
                    forceMoveMarkers: true
                }]);
                
                if (debugMode) {
                    console.log('[Monaco] Selection replaced');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Replace selection error:', error);
                return false;
            }
        }

        // Replace all text in the editor (preserves undo history)
        function replaceAllText(text) {
            if (!monacoEditor) {
                return false;
            }
            try {
                const model = monacoEditor.getModel();
                if (!model) {
                    return false;
                }
                
                // Get the full range of the document
                const fullRange = model.getFullModelRange();
                
                // Use executeEdits to replace all content while preserving undo
                monacoEditor.executeEdits('toolbar', [{
                    range: fullRange,
                    text: text,
                    forceMoveMarkers: true
                }]);
                
                if (debugMode) {
                    console.log('[Monaco] All text replaced (undo preserved)');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Replace all text error:', error);
                return false;
            }
        }

        // Insert text at cursor position
        function insertAtCursor(text) {
            if (!monacoEditor) {
                return false;
            }
            try {
                const position = monacoEditor.getPosition();
                if (!position) {
                    return false;
                }
                
                // Use executeEdits with pushUndoStop for proper undo stack integration
                monacoEditor.executeEdits('toolbar', [{
                    range: {
                        startLineNumber: position.lineNumber,
                        startColumn: position.column,
                        endLineNumber: position.lineNumber,
                        endColumn: position.column
                    },
                    text: text,
                    forceMoveMarkers: true
                }]);
                
                if (debugMode) {
                    console.log('[Monaco] Text inserted at cursor');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Insert at cursor error:', error);
                return false;
            }
        }

        // Get current cursor position
        function getCursorPosition() {
            if (!monacoEditor) {
                return { lineNumber: 1, column: 1 };
            }
            try {
                const position = monacoEditor.getPosition();
                return position || { lineNumber: 1, column: 1 };
            } catch (error) {
                console.error('[Monaco] Get cursor position error:', error);
                return { lineNumber: 1, column: 1 };
            }
        }

        // Trigger undo action
        function triggerUndo() {
            if (!monacoEditor) {
                return false;
            }
            try {
                monacoEditor.trigger('toolbar', 'undo');
                if (debugMode) {
                    console.log('[Monaco] Undo triggered');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Trigger undo error:', error);
                return false;
            }
        }

        // Trigger find dialog
        function triggerFind() {
            if (!monacoEditor) {
                return false;
            }
            try {
                monacoEditor.trigger('toolbar', 'actions.find');
                if (debugMode) {
                    console.log('[Monaco] Find dialog triggered');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Trigger find error:', error);
                return false;
            }
        }

        // Set word wrap mode
        function setWordWrap(enabled) {
            if (!monacoEditor) {
                return false;
            }
            try {
                monacoEditor.updateOptions({ 
                    wordWrap: enabled ? 'on' : 'off' 
                });
                if (debugMode) {
                    console.log('[Monaco] Word wrap:', enabled ? 'enabled' : 'disabled');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Set word wrap error:', error);
                return false;
            }
        }

        // Set render whitespace mode
        function setRenderWhitespace(mode) {
            if (!monacoEditor) {
                return false;
            }
            try {
                monacoEditor.updateOptions({ 
                    renderWhitespace: mode 
                });
                if (debugMode) {
                    console.log('[Monaco] Render whitespace:', mode);
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Set render whitespace error:', error);
                return false;
            }
        }

        // ============================================================================
        // SQL IntelliSense Support
        // ============================================================================

        // Register SQL IntelliSense with schema
        function registerSqlIntelliSense(schemaJson) {
            try {
                if (debugMode) console.log('[Monaco] Registering SQL IntelliSense');
                
                sqlSchema = JSON.parse(schemaJson);
                
                // Dispose existing providers
                if (sqlCompletionProvider) {
                    sqlCompletionProvider.dispose();
                }
                if (sqlHoverProvider) {
                    sqlHoverProvider.dispose();
                }
                
                // Register completion provider
                sqlCompletionProvider = monaco.languages.registerCompletionItemProvider('sql', {
                    provideCompletionItems: function(model, position) {
                        var suggestions = [];
                        var word = model.getWordUntilPosition(position);
                        var range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: word.startColumn,
                            endColumn: word.endColumn
                        };
                        
                        // Add tables as classes
                        if (sqlSchema.Tables) {
                            sqlSchema.Tables.forEach(function(table) {
                                suggestions.push({
                                    label: table.Name,
                                    kind: monaco.languages.CompletionItemKind.Class,
                                    detail: 'Table',
                                    insertText: table.Name,
                                    range: range
                                });
                                
                                // Add columns for this table
                                if (table.Columns) {
                                    table.Columns.forEach(function(column) {
                                        suggestions.push({
                                            label: table.Name + '.' + column.Name,
                                            kind: monaco.languages.CompletionItemKind.Field,
                                            detail: column.Type + (column.IsNullable ? ' (nullable)' : ''),
                                            insertText: table.Name + '.' + column.Name,
                                            documentation: (column.IsPrimaryKey ? 'Primary Key\n' : '') + 
                                                         'Type: ' + column.Type,
                                            range: range
                                        });
                                        
                                        // Also add column name without table prefix
                                        suggestions.push({
                                            label: column.Name,
                                            kind: monaco.languages.CompletionItemKind.Field,
                                            detail: table.Name + '.' + column.Type,
                                            insertText: column.Name,
                                            documentation: 'Column from ' + table.Name + '\n' +
                                                         (column.IsPrimaryKey ? 'Primary Key\n' : '') +
                                                         'Type: ' + column.Type,
                                            range: range
                                        });
                                    });
                                }
                            });
                        }
                        
                        // Add functions
                        if (sqlSchema.Functions) {
                            sqlSchema.Functions.forEach(function(func) {
                                suggestions.push({
                                    label: func.Name,
                                    kind: monaco.languages.CompletionItemKind.Function,
                                    detail: func.Category + ' function',
                                    insertText: func.Name + '(',
                                    documentation: func.Description,
                                    range: range
                                });
                            });
                        }
                        
                        // Add keywords
                        if (sqlSchema.Keywords) {
                            sqlSchema.Keywords.forEach(function(keyword) {
                                suggestions.push({
                                    label: keyword,
                                    kind: monaco.languages.CompletionItemKind.Keyword,
                                    detail: 'SQL Keyword',
                                    insertText: keyword,
                                    range: range
                                });
                            });
                        }
                        
                        return { suggestions: suggestions };
                    }
                });
                
                // Register hover provider
                sqlHoverProvider = monaco.languages.registerHoverProvider('sql', {
                    provideHover: function(model, position) {
                        var word = model.getWordAtPosition(position);
                        if (!word) return null;
                        
                        var wordText = word.word.toUpperCase();
                        
                        // Check functions
                        if (sqlSchema.Functions) {
                            var func = sqlSchema.Functions.find(function(f) { 
                                return f.Name.toUpperCase() === wordText; 
                            });
                            if (func) {
                                return {
                                    range: new monaco.Range(
                                        position.lineNumber, word.startColumn,
                                        position.lineNumber, word.endColumn
                                    ),
                                    contents: [
                                        { value: '**' + func.Name + '()**' },
                                        { value: func.Category + ' function' },
                                        { value: func.Description }
                                    ]
                                };
                            }
                        }
                        
                        // Check columns
                        if (sqlSchema.Tables) {
                            for (var i = 0; i < sqlSchema.Tables.length; i++) {
                                var table = sqlSchema.Tables[i];
                                if (table.Columns) {
                                    var column = table.Columns.find(function(c) { 
                                        return c.Name.toUpperCase() === wordText; 
                                    });
                                    if (column) {
                                        return {
                                            range: new monaco.Range(
                                                position.lineNumber, word.startColumn,
                                                position.lineNumber, word.endColumn
                                            ),
                                            contents: [
                                                { value: '**' + table.Name + '.' + column.Name + '**' },
                                                { value: 'Type: ' + column.Type },
                                                { value: (column.IsPrimaryKey ? 'Primary Key | ' : '') + 
                                                        (column.IsNullable ? 'Nullable' : 'Not Null') }
                                            ]
                                        };
                                    }
                                }
                            }
                        }
                        
                        return null;
                    }
                });
                
                // Enable validation for SQL language
                if (monacoEditor && monacoEditor.getModel().getLanguageId() === 'sql') {
                    scheduleValidation();
                }
                
                if (debugMode) {
                    console.log('[Monaco] SQL IntelliSense registered successfully');
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Register SQL IntelliSense error:', error);
                return false;
            }
        }

        // Schedule SQL validation with debounce
        function scheduleValidation() {
            if (!monacoEditor) return;
            
            var model = monacoEditor.getModel();
            if (!model || model.getLanguageId() !== 'sql') return;
            
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(function() {
                var sql = monacoEditor.getValue().trim();
                
                // Skip validation for empty SQL
                if (!sql) {
                    // Clear any existing markers
                    monaco.editor.setModelMarkers(model, 'sql-validator', []);
                    if (debugMode) {
                        console.log('[Monaco] SQL empty, clearing markers');
                    }
                    return;
                }
                
                // Skip validation for very short/incomplete SQL (less than 6 chars)
                if (sql.length < 6) {
                    if (debugMode) {
                        console.log('[Monaco] SQL too short, skipping validation');
                    }
                    return;
                }
                
                if (debugMode) {
                    console.log('[Monaco] Requesting SQL validation for:', sql.substring(0, 50));
                }
                window.chrome.webview.postMessage({ 
                    type: 'validateSql', 
                    sql: sql 
                });
            }, 800); // 800ms debounce (increased from 500ms)
        }

        // Set validation markers from C#
        function setValidationMarkers(markers) {
            if (!monacoEditor) return false;
            
            try {
                var model = monacoEditor.getModel();
                monaco.editor.setModelMarkers(model, 'sql-validator', markers || []);
                if (debugMode) {
                    if (!markers || markers.length === 0) {
                        console.log('[Monaco] Validation passed - markers cleared');
                    } else {
                        console.log('[Monaco] Validation markers set:', markers.length, markers);
                    }
                }
                return true;
            } catch (error) {
                console.error('[Monaco] Set validation markers error:', error);
                return false;
            }
        }

        // Parse SQLite error position from "near token" message
        function parseErrorPosition(sql, errorMessage) {
            try {
                // Extract token from "near \"TOKEN\"" pattern
                var nearMatch = errorMessage.match(/near\s+"([^"]+)"/i);
                if (!nearMatch) {
                    // Default to start of text
                    return { lineNumber: 1, column: 1 };
                }
                
                var token = nearMatch[1];
                var tokenIndex = sql.toUpperCase().indexOf(token.toUpperCase());
                
                if (tokenIndex === -1) {
                    return { lineNumber: 1, column: 1 };
                }
                
                // Calculate line and column from character index
                var lines = sql.substring(0, tokenIndex).split('\n');
                var lineNumber = lines.length;
                var column = lines[lines.length - 1].length + 1;
                
                return {
                    lineNumber: lineNumber,
                    column: column,
                    endColumn: column + token.length
                };
            } catch (error) {
                console.error('[Monaco] Parse error position error:', error);
                return { lineNumber: 1, column: 1 };
            }
        }

        if (debugMode) {
            console.log('[Monaco] Script loaded, waiting for initialization');
        }
    </script>
</body>
</html>
